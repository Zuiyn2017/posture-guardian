<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>坐姿守护助手</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --primary-light: #818cf8;
            --primary-dark: #4f46e5;
            --primary-glow: rgba(99, 102, 241, 0.4);
            --success: #10b981;
            --success-light: #34d399;
            --success-glow: rgba(16, 185, 129, 0.4);
            --warning: #f59e0b;
            --warning-light: #fbbf24;
            --danger: #ef4444;
            --danger-light: #f87171;
            --danger-glow: rgba(239, 68, 68, 0.4);
            --bg-start: #0f0f23;
            --bg-mid: #1a1a3e;
            --bg-end: #0d0d1f;
            --glass: rgba(255, 255, 255, 0.06);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-hover: rgba(255, 255, 255, 0.1);
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
            --transition-fast: 0.15s ease;
            --transition-normal: 0.25s ease;
            --transition-slow: 0.4s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            scroll-behavior: smooth;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
            background: linear-gradient(145deg, var(--bg-start) 0%, var(--bg-mid) 50%, var(--bg-end) 100%);
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 16px;
            padding-top: calc(16px + var(--safe-top));
            padding-bottom: calc(16px + var(--safe-bottom));
        }

        /* 背景动画 */
        .bg-effects {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: -1;
            overflow: hidden;
        }

        .bg-effects::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: 
                radial-gradient(ellipse 600px 400px at 20% 20%, rgba(99, 102, 241, 0.12) 0%, transparent 50%),
                radial-gradient(ellipse 500px 500px at 80% 80%, rgba(139, 92, 246, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse 400px 300px at 60% 30%, rgba(59, 130, 246, 0.08) 0%, transparent 50%);
            animation: aurora 25s ease-in-out infinite alternate;
        }

        @keyframes aurora {
            0% { transform: translate(0, 0) rotate(0deg) scale(1); }
            100% { transform: translate(-3%, 3%) rotate(2deg) scale(1.02); }
        }

        /* 主容器 */
        .app-container {
            width: 100%;
            max-width: 420px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            height: 100%;
            max-height: 100%;
            animation: fadeInUp 0.6s var(--transition-slow) both;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* 标题 */
        .app-header {
            text-align: center;
            padding: 8px 0;
            flex-shrink: 0;
            animation: fadeInUp 0.6s 0.1s var(--transition-slow) both;
        }

        .app-header h1 {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.02em;
        }

        .app-header h1 .material-icons-round {
            font-size: 1.6rem;
            color: var(--primary-light);
        }

        .app-header p {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* 视频卡片 */
        .video-card {
            position: relative;
            width: 100%;
            aspect-ratio: 3/4;
            border-radius: 24px;
            overflow: hidden;
            background: linear-gradient(145deg, rgba(30, 30, 60, 0.5), rgba(20, 20, 40, 0.7));
            border: 1px solid var(--glass-border);
            box-shadow: 
                0 25px 50px -12px rgba(0, 0, 0, 0.5),
                0 0 0 1px rgba(255, 255, 255, 0.03) inset;
            flex-shrink: 0;
            animation: fadeInUp 0.6s 0.2s var(--transition-slow) both;
            transition: box-shadow var(--transition-normal), transform var(--transition-normal);
        }

        .video-card:hover {
            box-shadow: 
                0 30px 60px -15px rgba(0, 0, 0, 0.6),
                0 0 0 1px rgba(255, 255, 255, 0.05) inset,
                0 0 40px -10px var(--primary-glow);
        }

        .video-wrapper {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border-radius: 24px;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform-origin: center center;
            transition: transform 0.2s ease-out;
        }

        canvas { display: none; }

        /* 扫描边框 */
        .scan-frame {
            position: absolute;
            inset: 12px;
            border: 2px solid transparent;
            border-radius: 16px;
            pointer-events: none;
            transition: all var(--transition-normal);
        }

        .scan-frame.active {
            border-color: var(--primary);
            box-shadow: 
                0 0 20px var(--primary-glow),
                inset 0 0 30px rgba(99, 102, 241, 0.08);
            animation: scan-pulse 1.8s ease-in-out infinite;
        }

        @keyframes scan-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* 角标装饰 */
        .corner-marks {
            position: absolute;
            inset: 20px;
            pointer-events: none;
        }

        .corner-marks::before,
        .corner-marks::after,
        .corner-marks span::before,
        .corner-marks span::after {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            border-color: rgba(255, 255, 255, 0.25);
            border-style: solid;
            border-width: 0;
            transition: border-color var(--transition-normal);
        }

        .corner-marks::before { top: 0; left: 0; border-top-width: 2px; border-left-width: 2px; border-radius: 6px 0 0 0; }
        .corner-marks::after { top: 0; right: 0; border-top-width: 2px; border-right-width: 2px; border-radius: 0 6px 0 0; }
        .corner-marks span::before { bottom: 0; left: 0; border-bottom-width: 2px; border-left-width: 2px; border-radius: 0 0 0 6px; }
        .corner-marks span::after { bottom: 0; right: 0; border-bottom-width: 2px; border-right-width: 2px; border-radius: 0 0 6px 0; }

        .scan-frame.active ~ .corner-marks::before,
        .scan-frame.active ~ .corner-marks::after,
        .scan-frame.active ~ .corner-marks span::before,
        .scan-frame.active ~ .corner-marks span::after {
            border-color: var(--primary-light);
        }

        /* 顶部状态栏 */
        .video-top-bar {
            position: absolute;
            top: 16px;
            left: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 10;
        }

        .status-pill {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: rgba(0, 0, 0, 0.45);
            backdrop-filter: blur(12px);
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            border: 1px solid rgba(255, 255, 255, 0.06);
            transition: all var(--transition-normal);
        }

        .status-pill:hover {
            background: rgba(0, 0, 0, 0.55);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
            transition: all var(--transition-normal);
        }

        .status-dot.active {
            background: var(--success);
            box-shadow: 0 0 12px var(--success-glow);
            animation: pulse-dot 1.5s ease-in-out infinite;
        }

        @keyframes pulse-dot {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(0.8); opacity: 0.6; }
        }

        .countdown-pill {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: rgba(0, 0, 0, 0.45);
            backdrop-filter: blur(12px);
            border-radius: 20px;
            font-size: 0.85rem;
            border: 1px solid rgba(255, 255, 255, 0.06);
            transition: all var(--transition-normal);
        }

        .countdown-pill:hover {
            background: rgba(0, 0, 0, 0.55);
        }

        .countdown-pill .material-icons-round {
            font-size: 1rem;
            color: var(--text-secondary);
        }

        .countdown-pill .time {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary-light);
            font-variant-numeric: tabular-nums;
            min-width: 24px;
            text-align: center;
        }

        /* 结果浮层 */
        .result-overlay {
            position: absolute;
            bottom: 70px;
            left: 16px;
            right: 16px;
            padding: 16px;
            background: rgba(0, 0, 0, 0.55);
            backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            border-radius: 18px;
            z-index: 10;
            opacity: 0;
            transform: translateY(12px);
            transition: all var(--transition-normal);
            pointer-events: none;
        }

        .result-overlay.show {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        .result-main {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .result-score-ring {
            position: relative;
            width: 56px;
            height: 56px;
            flex-shrink: 0;
        }

        .result-score-ring svg {
            transform: rotate(-90deg);
            width: 56px;
            height: 56px;
        }

        .result-score-ring .bg {
            fill: none;
            stroke: rgba(255, 255, 255, 0.08);
            stroke-width: 4;
        }

        .result-score-ring .progress {
            fill: none;
            stroke: var(--primary);
            stroke-width: 4;
            stroke-linecap: round;
            stroke-dasharray: 157;
            stroke-dashoffset: 157;
            transition: stroke-dashoffset 0.6s ease, stroke var(--transition-normal);
        }

        .result-score-ring .score-num {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            font-weight: 700;
            transition: color var(--transition-normal);
        }

        .result-info {
            flex: 1;
            min-width: 0;
        }

        .result-info h4 {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .result-info h4 .material-icons-round {
            font-size: 1.1rem;
        }

        .result-info p {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .result-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 12px;
        }

        .result-tag {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 5px 10px;
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger-light);
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 500;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .result-tag .material-icons-round {
            font-size: 0.9rem;
        }

        .result-suggestion {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin-top: 12px;
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.04);
            border-radius: 12px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.45;
        }

        .result-suggestion .material-icons-round {
            font-size: 1rem;
            color: var(--warning);
            flex-shrink: 0;
            margin-top: 1px;
        }

        /* 缩放控制 */
        .zoom-bar {
            position: absolute;
            bottom: 16px;
            left: 16px;
            right: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            background: rgba(0, 0, 0, 0.45);
            backdrop-filter: blur(12px);
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, 0.06);
            z-index: 10;
            transition: all var(--transition-normal);
        }

        .zoom-bar:hover {
            background: rgba(0, 0, 0, 0.55);
        }

        .zoom-bar .material-icons-round {
            font-size: 1.1rem;
            color: var(--text-secondary);
        }

        .zoom-bar input[type="range"] {
            flex: 1;
            height: 4px;
            -webkit-appearance: none;
            background: rgba(255, 255, 255, 0.12);
            border-radius: 2px;
            outline: none;
            cursor: pointer;
        }

        .zoom-bar input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-light), var(--primary));
            cursor: pointer;
            box-shadow: 0 2px 10px var(--primary-glow);
            transition: transform var(--transition-fast), box-shadow var(--transition-fast);
        }

        .zoom-bar input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 14px var(--primary-glow);
        }

        .zoom-bar input[type="range"]::-webkit-slider-thumb:active {
            transform: scale(1.15);
        }

        .zoom-bar .zoom-value {
            font-size: 0.85rem;
            font-weight: 600;
            min-width: 42px;
            text-align: right;
            color: var(--primary-light);
            font-variant-numeric: tabular-nums;
        }

        .zoom-bar .zoom-mode {
            font-size: 0.7rem;
            color: var(--text-muted);
            padding: 2px 6px;
            background: rgba(255,255,255,0.08);
            border-radius: 4px;
            white-space: nowrap;
        }

        .zoom-bar[data-mode="hardware"] .zoom-mode::after {
            content: "光学";
        }

        .zoom-bar[data-mode="digital"] .zoom-mode::after {
            content: "数字";
        }

        /* 摄像头选择器 */
        .camera-selector {
            position: absolute;
            top: 16px;
            right: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 11;
        }

        .camera-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(12px);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-normal);
        }

        .camera-btn:hover {
            background: rgba(0, 0, 0, 0.7);
            transform: scale(1.1);
        }

        .camera-btn:active {
            transform: scale(0.95);
        }

        .camera-btn .material-icons-round {
            font-size: 1.3rem;
        }

        .camera-name {
            padding: 6px 12px;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(12px);
            border-radius: 16px;
            font-size: 0.75rem;
            color: var(--text-secondary);
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* 摄像头选择面板 */
        .camera-panel {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 300;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-normal);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .camera-panel.show {
            opacity: 1;
            visibility: visible;
        }

        .camera-panel-content {
            width: 100%;
            max-width: 360px;
            max-height: 80vh;
            background: linear-gradient(145deg, var(--bg-mid), var(--bg-end));
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            overflow: hidden;
            transform: scale(0.9) translateY(20px);
            transition: transform var(--transition-slow);
            display: flex;
            flex-direction: column;
        }

        .camera-panel.show .camera-panel-content {
            transform: scale(1) translateY(0);
        }

        .camera-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 18px 20px;
            border-bottom: 1px solid var(--glass-border);
        }

        .camera-panel-header h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1rem;
            font-weight: 600;
        }

        .camera-panel-header h3 .material-icons-round {
            font-size: 1.2rem;
            color: var(--primary-light);
        }

        .camera-panel-header button {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: var(--glass);
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .camera-panel-header button:hover {
            background: var(--glass-hover);
            color: var(--text-primary);
        }

        .camera-list {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .camera-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 30px;
            color: var(--text-secondary);
        }

        .camera-loading .material-icons-round {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .camera-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 14px;
            cursor: pointer;
            transition: all var(--transition-normal);
        }

        .camera-item:hover {
            background: var(--glass-hover);
            border-color: var(--primary);
        }

        .camera-item.active {
            background: rgba(99, 102, 241, 0.15);
            border-color: var(--primary);
        }

        .camera-item-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: var(--glass);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .camera-item-icon .material-icons-round {
            font-size: 1.4rem;
            color: var(--text-secondary);
        }

        .camera-item.active .camera-item-icon {
            background: var(--primary);
        }

        .camera-item.active .camera-item-icon .material-icons-round {
            color: white;
        }

        .camera-item-info {
            flex: 1;
            min-width: 0;
        }

        .camera-item-name {
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .camera-item-desc {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .camera-item-check {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all var(--transition-fast);
        }

        .camera-item.active .camera-item-check {
            background: var(--primary);
            border-color: var(--primary);
        }

        .camera-item-check .material-icons-round {
            font-size: 1rem;
            color: white;
            opacity: 0;
            transition: opacity var(--transition-fast);
        }

        .camera-item.active .camera-item-check .material-icons-round {
            opacity: 1;
        }

        .camera-tips {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            padding: 12px 16px;
            background: rgba(245, 158, 11, 0.1);
            border-top: 1px solid var(--glass-border);
            font-size: 0.75rem;
            color: var(--warning);
            line-height: 1.4;
        }

        .camera-tips .material-icons-round {
            font-size: 1rem;
            flex-shrink: 0;
            margin-top: 1px;
        }

        /* 控制按钮 */
        .controls {
            display: flex;
            gap: 12px;
            flex-shrink: 0;
            animation: fadeInUp 0.6s 0.3s var(--transition-slow) both;
        }

        .btn {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 16px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all var(--transition-normal);
            letter-spacing: -0.01em;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, transparent 50%);
            opacity: 0;
            transition: opacity var(--transition-normal);
        }

        .btn:hover::before {
            opacity: 1;
        }

        .btn:active {
            transform: scale(0.97);
        }

        .btn .material-icons-round {
            font-size: 1.2rem;
            transition: transform var(--transition-fast);
        }

        .btn:hover .material-icons-round {
            transform: scale(1.1);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: 0 8px 24px -8px var(--primary-glow);
        }

        .btn-primary:hover {
            box-shadow: 0 12px 32px -8px var(--primary-glow);
            transform: translateY(-2px);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
            color: white;
            box-shadow: 0 8px 24px -8px var(--danger-glow);
        }

        .btn-danger:hover {
            box-shadow: 0 12px 32px -8px var(--danger-glow);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--glass);
            color: var(--text-primary);
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(12px);
        }

        .btn-secondary:hover {
            background: var(--glass-hover);
            border-color: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn:disabled:hover {
            transform: none !important;
            box-shadow: none;
        }

        /* Toast */
        .toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(16px);
            padding: 14px 24px;
            border-radius: 14px;
            border: 1px solid var(--glass-border);
            font-size: 0.9rem;
            font-weight: 500;
            opacity: 0;
            pointer-events: none;
            transition: all var(--transition-normal);
            z-index: 100;
        }

        .toast .material-icons-round {
            font-size: 1.2rem;
            color: var(--primary-light);
        }

        .toast.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }

        /* 历史记录按钮 */
        .history-btn {
            position: fixed;
            bottom: calc(20px + var(--safe-bottom));
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 8px 24px -4px var(--primary-glow);
            transition: all var(--transition-normal);
            z-index: 50;
        }

        .history-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 32px -4px var(--primary-glow);
        }

        .history-btn:active {
            transform: scale(0.95);
        }

        .history-btn .material-icons-round {
            font-size: 1.5rem;
        }

        .history-btn .badge {
            position: absolute;
            top: -4px;
            right: -4px;
            min-width: 20px;
            height: 20px;
            padding: 0 6px;
            background: var(--danger);
            color: white;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* 历史记录面板 */
        .history-panel {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 200;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-normal);
        }

        .history-panel.show {
            opacity: 1;
            visibility: visible;
        }

        .history-content {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            max-height: 85vh;
            background: linear-gradient(145deg, var(--bg-mid), var(--bg-end));
            border-top-left-radius: 24px;
            border-top-right-radius: 24px;
            border: 1px solid var(--glass-border);
            border-bottom: none;
            transform: translateY(100%);
            transition: transform var(--transition-slow);
            display: flex;
            flex-direction: column;
            padding-bottom: var(--safe-bottom);
        }

        .history-panel.show .history-content {
            transform: translateY(0);
        }

        .history-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 20px 16px;
            border-bottom: 1px solid var(--glass-border);
            flex-shrink: 0;
        }

        .history-header h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .history-header h3 .material-icons-round {
            font-size: 1.3rem;
            color: var(--primary-light);
        }

        .history-header-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .history-header button {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: var(--glass);
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .history-header button:hover {
            background: var(--glass-hover);
            color: var(--text-primary);
        }

        .history-list {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .history-empty {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
            color: var(--text-muted);
            padding: 40px;
        }

        .history-empty .material-icons-round {
            font-size: 3rem;
            opacity: 0.5;
        }

        .history-item {
            display: flex;
            gap: 14px;
            padding: 14px;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            animation: fadeInUp 0.3s ease both;
        }

        .history-item-score {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: 700;
            flex-shrink: 0;
        }

        .history-item-score.good {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
        }

        .history-item-score.bad {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
        }

        .history-item-score.neutral {
            background: rgba(100, 116, 139, 0.15);
            color: var(--text-secondary);
        }

        .history-item-content {
            flex: 1;
            min-width: 0;
        }

        .history-item-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .history-item-title {
            font-size: 0.95rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .history-item-title .material-icons-round {
            font-size: 1rem;
        }

        .history-item-time {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .history-item-issues {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 8px;
        }

        .history-item-issues span {
            padding: 3px 8px;
            background: rgba(239, 68, 68, 0.12);
            color: var(--danger-light);
            border-radius: 8px;
            font-size: 0.7rem;
        }

        .history-item-suggestion {
            margin-top: 8px;
            padding: 8px 10px;
            background: rgba(255, 255, 255, 0.04);
            border-radius: 8px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        /* 响应式 - 平板 */
        @media (min-width: 768px) {
            body {
                padding: 24px;
            }

            .app-container {
                max-width: 400px;
            }

            .app-header h1 {
                font-size: 1.6rem;
            }

            .video-card {
                box-shadow: 
                    0 40px 80px -20px rgba(0, 0, 0, 0.6),
                    0 0 0 1px rgba(255, 255, 255, 0.05) inset;
            }

            .btn {
                padding: 18px;
            }
        }

        /* 响应式 - 小屏幕 */
        @media (max-height: 700px) {
            .app-header h1 { font-size: 1.3rem; }
            .app-header p { display: none; }
            .video-card { aspect-ratio: 4/5; }
            .btn { padding: 14px; }
        }

        @media (max-height: 600px) {
            .app-header { padding: 4px 0; }
            .app-container { gap: 12px; }
            .video-card { aspect-ratio: 1/1; }
        }

        /* 响应式 - 大屏幕 */
        @media (min-width: 1024px) {
            .app-container {
                max-width: 380px;
            }

            .video-card:hover {
                transform: translateY(-4px);
            }
        }

        /* 触摸设备优化 */
        @media (hover: none) {
            .btn:hover {
                transform: none;
            }
            
            .btn:active {
                transform: scale(0.97);
            }

            .video-card:hover {
                transform: none;
            }
        }
    </style>
</head>
<body>
    <div class="bg-effects"></div>

    <div class="app-container">
        <!-- 标题 -->
        <header class="app-header">
            <h1>
                <span class="material-icons-round">edit_note</span>
                坐姿守护助手
            </h1>
            <p>保护视力，从好姿势开始</p>
        </header>

        <!-- 视频卡片 -->
        <div class="video-card">
            <div class="video-wrapper">
                <video id="video" autoplay playsinline muted></video>
            </div>
            
            <!-- 扫描框 -->
            <div id="scanFrame" class="scan-frame"></div>
            
            <!-- 角标 -->
            <div class="corner-marks"><span></span></div>
            
            <!-- 顶部状态 -->
            <div class="video-top-bar">
                <div class="status-pill">
                    <div id="statusDot" class="status-dot"></div>
                    <span id="statusText">准备就绪</span>
                </div>
                <div class="countdown-pill">
                    <span class="material-icons-round">timer</span>
                    <span id="countdown" class="time">--</span>
                    <span>秒</span>
                </div>
            </div>

            <!-- 结果浮层 -->
            <div id="resultOverlay" class="result-overlay">
                <div class="result-main">
                    <div class="result-score-ring">
                        <svg viewBox="0 0 56 56">
                            <circle class="bg" cx="28" cy="28" r="25"></circle>
                            <circle id="resultProgress" class="progress" cx="28" cy="28" r="25"></circle>
                        </svg>
                        <div id="resultScoreNum" class="score-num">--</div>
                    </div>
                    <div class="result-info">
                        <h4 id="resultTitle">
                            <span class="material-icons-round" id="resultIcon">hourglass_empty</span>
                            等待检测
                        </h4>
                        <p id="resultDesc">点击开始监测</p>
                    </div>
                </div>
                <div id="resultTags" class="result-tags"></div>
                <div id="resultSuggestion" class="result-suggestion" style="display:none;">
                    <span class="material-icons-round">lightbulb</span>
                    <span id="resultSuggestionText"></span>
                </div>
            </div>

            <!-- 摄像头选择 -->
            <div class="camera-selector">
                <button id="cameraSwitchBtn" class="camera-btn" onclick="showCameraSelector()" title="切换摄像头">
                    <span class="material-icons-round">flip_camera_ios</span>
                </button>
                <span id="cameraName" class="camera-name">主摄像头</span>
            </div>

            <!-- 缩放控制 -->
            <div class="zoom-bar" data-mode="digital">
                <span class="material-icons-round">zoom_out</span>
                <input id="zoomSlider" type="range" min="1" max="3" step="0.1" value="1">
                <span class="material-icons-round">zoom_in</span>
                <span id="zoomValue" class="zoom-value">1.0x</span>
                <span class="zoom-mode"></span>
            </div>

            <canvas id="canvas"></canvas>
        </div>

        <!-- 控制按钮 -->
        <div class="controls">
            <button id="toggleBtn" class="btn btn-primary" onclick="toggleMonitoring()">
                <span class="material-icons-round">play_arrow</span>
                开始监测
            </button>
            <button id="manualBtn" class="btn btn-secondary" onclick="manualCheck()" disabled>
                <span class="material-icons-round">camera</span>
                立即检测
            </button>
        </div>
    </div>

    <div id="toast" class="toast">
        <span class="material-icons-round">check_circle</span>
        <span id="toastText"></span>
    </div>

    <!-- 历史记录按钮 -->
    <button class="history-btn" onclick="toggleHistoryPanel()">
        <span class="material-icons-round">history</span>
        <span id="historyBadge" class="badge" style="display:none;">0</span>
    </button>

    <!-- 摄像头选择面板 -->
    <div id="cameraSelectorPanel" class="camera-panel" onclick="hideCameraSelector(event)">
        <div class="camera-panel-content" onclick="event.stopPropagation()">
            <div class="camera-panel-header">
                <h3>
                    <span class="material-icons-round">camera</span>
                    选择摄像头
                </h3>
                <button onclick="hideCameraSelector()">
                    <span class="material-icons-round">close</span>
                </button>
            </div>
            <div id="cameraList" class="camera-list">
                <div class="camera-loading">
                    <span class="material-icons-round">sync</span>
                    正在获取摄像头列表...
                </div>
            </div>
            <div class="camera-tips">
                <span class="material-icons-round">info</span>
                <span>选择"主摄像头"可获得最佳画质。如果画面被放大，请尝试其他摄像头。</span>
            </div>
        </div>
    </div>

    <!-- 历史记录面板 -->
    <div id="historyPanel" class="history-panel" onclick="closeHistoryPanel(event)">
        <div class="history-content" onclick="event.stopPropagation()">
            <div class="history-header">
                <h3>
                    <span class="material-icons-round">history</span>
                    检测记录
                </h3>
                <div class="history-header-actions">
                    <button onclick="clearHistory()" title="清空记录">
                        <span class="material-icons-round">delete_outline</span>
                    </button>
                    <button onclick="closeHistoryPanel()" title="关闭">
                        <span class="material-icons-round">close</span>
                    </button>
                </div>
            </div>
            <div id="historyList" class="history-list">
                <div class="history-empty">
                    <span class="material-icons-round">inbox</span>
                    <span>暂无检测记录</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============ 状态变量 ============
        let stream = null;
        let videoTrack = null;
        let intervalId = null;
        let countdownId = null;
        let isMonitoring = false;
        let isChecking = false;
        let zoomFactor = 1.0;
        let supportsHardwareZoom = false;
        let zoomCapabilities = { min: 0.5, max: 3, step: 0.1 };
        const CHECK_INTERVAL = 30;
        let timeLeft = CHECK_INTERVAL;
        
        // 摄像头相关
        let allCameras = [];
        let currentCameraId = null;
        let currentCameraIndex = 0;

        // ============ DOM 元素 ============
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const toggleBtn = document.getElementById('toggleBtn');
        const manualBtn = document.getElementById('manualBtn');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const scanFrame = document.getElementById('scanFrame');
        const countdownEl = document.getElementById('countdown');
        const zoomSlider = document.getElementById('zoomSlider');
        const zoomValueEl = document.getElementById('zoomValue');
        const resultOverlay = document.getElementById('resultOverlay');
        const resultProgress = document.getElementById('resultProgress');
        const resultScoreNum = document.getElementById('resultScoreNum');
        const resultTitle = document.getElementById('resultTitle');
        const resultIcon = document.getElementById('resultIcon');
        const resultDesc = document.getElementById('resultDesc');
        const resultTags = document.getElementById('resultTags');
        const resultSuggestion = document.getElementById('resultSuggestion');
        const resultSuggestionText = document.getElementById('resultSuggestionText');

        // ============ 摄像头控制 ============
        
        // 获取所有摄像头列表
        async function getCameraList() {
            try {
                // 先请求权限
                await navigator.mediaDevices.getUserMedia({ video: true });
                
                const devices = await navigator.mediaDevices.enumerateDevices();
                allCameras = devices.filter(d => d.kind === 'videoinput');
                
                console.log('检测到摄像头:', allCameras.map(c => ({
                    id: c.deviceId,
                    label: c.label
                })));
                
                return allCameras;
            } catch (err) {
                console.error('获取摄像头列表失败:', err);
                return [];
            }
        }

        // 解析摄像头类型
        function parseCameraType(label) {
            const lowerLabel = label.toLowerCase();
            
            // 华为/荣耀设备
            if (lowerLabel.includes('facing back') || lowerLabel.includes('后置')) {
                if (lowerLabel.includes('wide') || lowerLabel.includes('广角')) {
                    return { type: 'wide', name: '超广角', icon: 'panorama_wide_angle', priority: 2 };
                }
                if (lowerLabel.includes('tele') || lowerLabel.includes('长焦') || lowerLabel.includes('zoom')) {
                    return { type: 'tele', name: '长焦', icon: 'zoom_in', priority: 3 };
                }
                if (lowerLabel.includes('macro') || lowerLabel.includes('微距')) {
                    return { type: 'macro', name: '微距', icon: 'filter_center_focus', priority: 4 };
                }
                // 主摄通常是 camera 0 或没有特殊标识
                return { type: 'main', name: '主摄', icon: 'camera', priority: 1 };
            }
            
            if (lowerLabel.includes('facing front') || lowerLabel.includes('前置')) {
                return { type: 'front', name: '前置', icon: 'face', priority: 10 };
            }
            
            // 根据索引和标签猜测
            if (lowerLabel.includes('0') || lowerLabel.includes('main') || lowerLabel === '') {
                return { type: 'main', name: '主摄', icon: 'camera', priority: 1 };
            }
            
            return { type: 'unknown', name: '摄像头', icon: 'videocam', priority: 5 };
        }

        // 获取摄像头显示名称
        function getCameraDisplayName(camera, index) {
            const label = camera.label || '';
            const parsed = parseCameraType(label);
            
            if (label) {
                // 简化标签
                let shortLabel = label
                    .replace(/camera/gi, '')
                    .replace(/facing back/gi, '后置')
                    .replace(/facing front/gi, '前置')
                    .replace(/\d+,\s*/g, '')
                    .trim();
                
                if (shortLabel.length > 20) {
                    shortLabel = parsed.name;
                }
                return shortLabel || parsed.name;
            }
            
            return `摄像头 ${index + 1}`;
        }

        // 使用指定摄像头启动（带重试机制）
        async function startCameraWithId(deviceId = null, retryCount = 0) {
            const MAX_RETRIES = 3;
            const RETRY_DELAY = 500;

            // 先停止现有流并等待释放
            await stopCamera();

            const constraints = {
                video: {
                    width: { ideal: 1920 },
                    height: { ideal: 1080 }
                }
            };

            if (deviceId) {
                constraints.video.deviceId = { exact: deviceId };
            }

            try {
                console.log(`尝试启动摄像头 (尝试 ${retryCount + 1}/${MAX_RETRIES + 1}):`, deviceId || 'default');
                
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                videoTrack = stream.getVideoTracks()[0];
                
                // 等待视频流加载完成
                await waitForVideoReady();
                
                currentCameraId = videoTrack.getSettings().deviceId;
                
                // 更新当前摄像头索引
                currentCameraIndex = allCameras.findIndex(c => c.deviceId === currentCameraId);
                if (currentCameraIndex === -1) currentCameraIndex = 0;

                // 更新显示名称
                updateCameraNameDisplay();

                // 检查缩放能力
                await checkZoomCapabilities();

                console.log('摄像头已启动:', videoTrack.label);
                return true;
            } catch (err) {
                console.error(`启动摄像头失败 (尝试 ${retryCount + 1}):`, err.name, err.message);
                
                // 如果还有重试机会
                if (retryCount < MAX_RETRIES) {
                    console.log(`等待 ${RETRY_DELAY}ms 后重试...`);
                    await new Promise(r => setTimeout(r, RETRY_DELAY));
                    return startCameraWithId(deviceId, retryCount + 1);
                }
                
                showToast('摄像头启动失败，请重试', 'error');
                return false;
            }
        }

        // 等待视频流加载完成
        function waitForVideoReady() {
            return new Promise((resolve, reject) => {
                const timeout = setTimeout(() => {
                    reject(new Error('视频加载超时'));
                }, 5000);

                if (video.readyState >= 2) {
                    clearTimeout(timeout);
                    resolve();
                    return;
                }

                const onLoaded = () => {
                    clearTimeout(timeout);
                    video.removeEventListener('loadeddata', onLoaded);
                    video.removeEventListener('error', onError);
                    resolve();
                };

                const onError = (e) => {
                    clearTimeout(timeout);
                    video.removeEventListener('loadeddata', onLoaded);
                    video.removeEventListener('error', onError);
                    reject(e);
                };

                video.addEventListener('loadeddata', onLoaded);
                video.addEventListener('error', onError);
            });
        }

        // 更新摄像头名称显示
        function updateCameraNameDisplay() {
            const cameraNameEl = document.getElementById('cameraName');
            if (cameraNameEl && allCameras[currentCameraIndex]) {
                cameraNameEl.textContent = getCameraDisplayName(allCameras[currentCameraIndex], currentCameraIndex);
            }
        }

        async function startCamera() {
            try {
                // 获取摄像头列表
                await getCameraList();
                
                if (allCameras.length === 0) {
                    showToast('未检测到摄像头', 'error');
                    return false;
                }

                // 尝试选择主摄（通常是第一个后置摄像头，而不是长焦）
                let targetCamera = null;
                
                // 优先选择标签中包含 "0" 或 "main" 或没有 "tele/zoom/wide" 的后置摄像头
                const backCameras = allCameras.filter(c => {
                    const label = c.label.toLowerCase();
                    return !label.includes('front') && !label.includes('前置');
                });

                if (backCameras.length > 0) {
                    // 按优先级排序，选择主摄
                    const sortedCameras = backCameras.map((c, i) => ({
                        camera: c,
                        index: i,
                        ...parseCameraType(c.label)
                    })).sort((a, b) => a.priority - b.priority);
                    
                    targetCamera = sortedCameras[0]?.camera;
                    console.log('选择摄像头:', targetCamera?.label, '优先级:', sortedCameras[0]?.priority);
                }

                // 启动选中的摄像头
                const success = await startCameraWithId(targetCamera?.deviceId || null);
                
                if (success) {
                    showToast('摄像头已启动', 'videocam');
                }
                
                return success;
            } catch (err) {
                console.error('摄像头启动失败:', err);
                showToast('无法访问摄像头', 'error');
                return false;
            }
        }

        // 切换到下一个摄像头
        async function switchToNextCamera() {
            if (allCameras.length <= 1) {
                showToast('只有一个摄像头', 'info');
                return;
            }

            if (isSwitchingCamera) {
                showToast('正在切换中，请稍候...', 'hourglass_empty');
                return;
            }

            isSwitchingCamera = true;
            
            const nextIndex = (currentCameraIndex + 1) % allCameras.length;
            const nextCamera = allCameras[nextIndex];
            
            showToast('正在切换摄像头...', 'flip_camera_ios');
            
            try {
                const success = await startCameraWithId(nextCamera.deviceId);
                if (success) {
                    currentCameraIndex = nextIndex;
                    showToast(`已切换: ${getCameraDisplayName(nextCamera, nextIndex)}`, 'check_circle');
                }
            } finally {
                isSwitchingCamera = false;
            }
        }

        // 显示摄像头选择面板
        async function showCameraSelector() {
            const panel = document.getElementById('cameraSelectorPanel');
            const listEl = document.getElementById('cameraList');
            
            panel.classList.add('show');
            
            // 刷新摄像头列表
            await getCameraList();
            
            if (allCameras.length === 0) {
                listEl.innerHTML = `
                    <div class="camera-loading">
                        <span class="material-icons-round">videocam_off</span>
                        未检测到摄像头
                    </div>
                `;
                return;
            }

            listEl.innerHTML = allCameras.map((camera, index) => {
                const parsed = parseCameraType(camera.label);
                const displayName = getCameraDisplayName(camera, index);
                const isActive = camera.deviceId === currentCameraId;
                
                return `
                    <div class="camera-item ${isActive ? 'active' : ''}" onclick="selectCamera('${camera.deviceId}', ${index})">
                        <div class="camera-item-icon">
                            <span class="material-icons-round">${parsed.icon}</span>
                        </div>
                        <div class="camera-item-info">
                            <div class="camera-item-name">${displayName}</div>
                            <div class="camera-item-desc">${camera.label || '摄像头 ' + (index + 1)}</div>
                        </div>
                        <div class="camera-item-check">
                            <span class="material-icons-round">check</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 隐藏摄像头选择面板
        function hideCameraSelector(event) {
            if (!event || event.target.id === 'cameraSelectorPanel') {
                document.getElementById('cameraSelectorPanel').classList.remove('show');
            }
        }

        // 选择指定摄像头
        let isSwitchingCamera = false;
        
        async function selectCamera(deviceId, index) {
            if (deviceId === currentCameraId) {
                hideCameraSelector();
                return;
            }

            // 防止重复点击
            if (isSwitchingCamera) {
                showToast('正在切换中，请稍候...', 'hourglass_empty');
                return;
            }

            isSwitchingCamera = true;
            
            // 更新UI状态
            const items = document.querySelectorAll('.camera-item');
            items.forEach(el => el.style.opacity = '0.5');
            
            showToast('正在切换摄像头...', 'flip_camera_ios');
            
            try {
                const success = await startCameraWithId(deviceId);
                
                if (success) {
                    currentCameraIndex = index;
                    showToast(`已切换: ${getCameraDisplayName(allCameras[index], index)}`, 'check_circle');
                    
                    // 更新列表选中状态
                    items.forEach((el, i) => {
                        el.classList.toggle('active', i === index);
                        el.style.opacity = '1';
                    });
                } else {
                    // 恢复UI
                    items.forEach(el => el.style.opacity = '1');
                }
            } finally {
                isSwitchingCamera = false;
            }
            
            hideCameraSelector();
        }

        // 检查摄像头缩放能力
        async function checkZoomCapabilities() {
            if (!videoTrack) return;

            // 确保视频初始状态不被放大
            video.style.transform = 'none';

            try {
                // 获取摄像头能力
                const capabilities = videoTrack.getCapabilities();
                console.log('摄像头能力:', capabilities);

                if (capabilities.zoom) {
                    supportsHardwareZoom = true;
                    zoomCapabilities = {
                        min: capabilities.zoom.min || 1,
                        max: capabilities.zoom.max || 10,
                        step: capabilities.zoom.step || 0.1
                    };
                    console.log('支持硬件缩放:', zoomCapabilities);

                    // 更新滑杆范围
                    zoomSlider.min = zoomCapabilities.min;
                    zoomSlider.max = zoomCapabilities.max;
                    zoomSlider.step = zoomCapabilities.step;
                    zoomSlider.value = zoomCapabilities.min; // 从最小值开始
                    
                    // 初始化为最小缩放
                    await setZoom(zoomCapabilities.min);

                    showToast('支持摄像头缩放', 'zoom_in');
                    updateZoomModeUI(true);
                } else {
                    supportsHardwareZoom = false;
                    console.log('不支持硬件缩放，使用数字缩放（仅截图时生效）');
                    
                    // 数字缩放：只在截图时裁剪，预览保持原样
                    zoomSlider.min = 1;
                    zoomSlider.max = 3;
                    zoomSlider.step = 0.1;
                    zoomSlider.value = 1;
                    zoomFactor = 1;
                    zoomValueEl.textContent = '1.0x';

                    showToast('数字缩放（截图时生效）', 'crop');
                    updateZoomModeUI(false);
                }
            } catch (err) {
                console.warn('获取摄像头能力失败:', err);
                supportsHardwareZoom = false;
                zoomSlider.value = 1;
                zoomFactor = 1;
                zoomValueEl.textContent = '1.0x';
                updateZoomModeUI(false);
            }
        }

        // 更新缩放模式UI提示
        function updateZoomModeUI(isHardware) {
            const zoomBar = document.querySelector('.zoom-bar');
            if (zoomBar) {
                if (isHardware) {
                    zoomBar.setAttribute('data-mode', 'hardware');
                    zoomBar.title = '摄像头光学缩放';
                } else {
                    zoomBar.setAttribute('data-mode', 'digital');
                    zoomBar.title = '数字缩放（截图时裁剪中心区域）';
                }
            }
        }

        function stopCamera() {
            return new Promise((resolve) => {
                if (stream) {
                    // 停止所有轨道
                    stream.getTracks().forEach(track => {
                        track.stop();
                        console.log('停止轨道:', track.label);
                    });
                    
                    // 清除视频源
                    video.srcObject = null;
                    stream = null;
                    videoTrack = null;
                }
                
                // 重置视频变换
                video.style.transform = 'none';
                
                // 给设备时间释放资源
                setTimeout(resolve, 300);
            });
        }

        // ============ 缩放控制 ============
        async function setZoom(value) {
            zoomFactor = parseFloat(value);
            zoomValueEl.textContent = `${zoomFactor.toFixed(1)}x`;

            if (supportsHardwareZoom && videoTrack) {
                // 使用摄像头硬件缩放（真正的光学/数字变焦）
                try {
                    await videoTrack.applyConstraints({
                        advanced: [{ zoom: zoomFactor }]
                    });
                    // 硬件缩放成功，视频预览会自动更新
                    video.style.transform = 'none';
                    console.log('硬件缩放设置成功:', zoomFactor);
                } catch (err) {
                    console.warn('硬件缩放失败:', err);
                    // 回退到数字缩放模式
                    supportsHardwareZoom = false;
                    updateZoomModeUI(false);
                    showToast('切换到数字缩放', 'crop');
                }
            }
            // 数字缩放模式：不修改视频预览，只在截图时裁剪
            // 视频保持原样，zoomFactor 用于 captureAndCheck 时的裁剪
        }

        // ============ 坐姿检测 ============
        async function captureAndCheck() {
            if (!stream || isChecking) return;

            isChecking = true;
            scanFrame.classList.add('active');
            statusText.textContent = '分析中...';

            try {
                const context = canvas.getContext('2d');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;

                if (supportsHardwareZoom) {
                    // 硬件缩放时，直接绘制整个画面（摄像头已经缩放了）
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);
                } else {
                    // 数字缩放时，裁剪中心区域
                    const cropW = canvas.width / zoomFactor;
                    const cropH = canvas.height / zoomFactor;
                    const sx = (canvas.width - cropW) / 2;
                    const sy = (canvas.height - cropH) / 2;

                    context.drawImage(
                        video,
                        sx, sy, cropW, cropH,
                        0, 0, canvas.width, canvas.height
                    );
                }

                const imageData = canvas.toDataURL('image/jpeg', 0.7);

                const response = await fetch('/check', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: imageData })
                });

                const data = await response.json();
                handleResult(data);

            } catch (err) {
                console.error('检测失败:', err);
                showToast('网络请求失败', 'error');
                updateResult('--', '请求失败', '请检查网络连接', 'error', [], '');
            } finally {
                isChecking = false;
                scanFrame.classList.remove('active');
                statusText.textContent = isMonitoring ? '监测中' : '已暂停';
            }
        }

        function handleResult(data) {
            const status = data.status || 'normal';
            const score = data.score !== undefined ? data.score : '--';
            const isQualified = data.is_qualified || false;
            const issues = data.issues || [];
            const suggestion = data.suggestion || '';

            let title, desc, icon, type;

            if (status === 'no_person') {
                title = '未检测到人物';
                desc = '请确保画面中有人';
                icon = 'person_off';
                type = 'neutral';
            } else if (status === 'not_writing') {
                title = '不在写字状态';
                desc = '请保持写字姿势';
                icon = 'edit_off';
                type = 'neutral';
            } else if (score >= 80) {
                title = '姿势正确';
                desc = '继续保持！';
                icon = 'check_circle';
                type = 'good';
            } else if (score >= 60) {
                title = '需要改进';
                desc = '稍微调整一下';
                icon = 'info';
                type = 'warning';
            } else {
                title = '姿势不佳';
                desc = '请调整坐姿';
                icon = 'warning';
                type = 'bad';
            }

            updateResult(score, title, desc, icon, type, issues, suggestion);

            // 保存到历史记录
            addToHistory(data);

            if (status === 'normal' && data.audio) {
                playAudio(data.audio);
            }

            console.log('检测结果:', data);
        }

        function updateResult(score, title, desc, icon, type, issues, suggestion) {
            resultScoreNum.textContent = score;
            resultIcon.textContent = icon;
            resultTitle.innerHTML = `<span class="material-icons-round">${icon}</span>${title}`;
            resultDesc.textContent = desc;

            // 更新进度环
            const circumference = 157;
            let offset = circumference;
            let strokeColor = 'var(--text-muted)';

            if (typeof score === 'number' && score >= 0) {
                offset = circumference - (score / 100) * circumference;
                if (type === 'good') strokeColor = 'var(--success)';
                else if (type === 'warning') strokeColor = 'var(--warning)';
                else if (type === 'bad') strokeColor = 'var(--danger)';
                else strokeColor = 'var(--primary)';
            }

            resultProgress.style.strokeDashoffset = offset;
            resultProgress.style.stroke = strokeColor;
            resultScoreNum.style.color = strokeColor;

            // 问题标签
            if (issues && issues.length > 0) {
                resultTags.innerHTML = issues.map(i => 
                    `<span class="result-tag"><span class="material-icons-round">report_problem</span>${i}</span>`
                ).join('');
                resultTags.style.display = 'flex';
            } else {
                resultTags.style.display = 'none';
            }

            // 建议
            if (suggestion) {
                resultSuggestionText.textContent = suggestion;
                resultSuggestion.style.display = 'flex';
            } else {
                resultSuggestion.style.display = 'none';
            }

            resultOverlay.classList.add('show');
        }

        function playAudio(base64Audio) {
            try {
                const audio = new Audio("data:audio/mp3;base64," + base64Audio);
                audio.play().catch(e => console.log("音频播放需要用户交互:", e));
            } catch (e) {
                console.error("音频创建失败:", e);
            }
        }

        // ============ 监测控制 ============
        async function toggleMonitoring() {
            if (!isMonitoring) {
                if (!stream) {
                    const success = await startCamera();
                    if (!success) return;
                }

                isMonitoring = true;
                toggleBtn.innerHTML = '<span class="material-icons-round">pause</span>停止监测';
                toggleBtn.classList.remove('btn-primary');
                toggleBtn.classList.add('btn-danger');
                manualBtn.disabled = false;
                statusDot.classList.add('active');
                statusText.textContent = '监测中';

                captureAndCheck();

                timeLeft = CHECK_INTERVAL;
                countdownEl.textContent = timeLeft;

                countdownId = setInterval(() => {
                    timeLeft--;
                    countdownEl.textContent = timeLeft;
                    if (timeLeft <= 0) timeLeft = CHECK_INTERVAL;
                }, 1000);

                intervalId = setInterval(captureAndCheck, CHECK_INTERVAL * 1000);
                showToast('开始监测', 'play_circle');

            } else {
                isMonitoring = false;
                toggleBtn.innerHTML = '<span class="material-icons-round">play_arrow</span>开始监测';
                toggleBtn.classList.remove('btn-danger');
                toggleBtn.classList.add('btn-primary');
                manualBtn.disabled = true;
                statusDot.classList.remove('active');
                statusText.textContent = '已暂停';
                countdownEl.textContent = '--';

                clearInterval(intervalId);
                clearInterval(countdownId);
                showToast('已停止监测', 'pause_circle');
            }
        }

        function manualCheck() {
            if (!isMonitoring || isChecking) return;
            timeLeft = CHECK_INTERVAL;
            countdownEl.textContent = timeLeft;
            captureAndCheck();
        }

        // ============ Toast ============
        function showToast(message, icon = 'check_circle', duration = 1500) {
            const toast = document.getElementById('toast');
            const toastText = document.getElementById('toastText');
            const toastIcon = toast.querySelector('.material-icons-round');
            
            toastIcon.textContent = icon;
            toastText.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => toast.classList.remove('show'), duration);
        }

        // ============ 历史记录管理 ============
        let historyLogs = [];
        const historyPanel = document.getElementById('historyPanel');
        const historyList = document.getElementById('historyList');
        const historyBadge = document.getElementById('historyBadge');

        function toggleHistoryPanel() {
            historyPanel.classList.toggle('show');
            if (historyPanel.classList.contains('show')) {
                loadHistory();
            }
        }

        function closeHistoryPanel(event) {
            if (!event || event.target === historyPanel) {
                historyPanel.classList.remove('show');
            }
        }

        function addToHistory(data) {
            const record = {
                timestamp: new Date().toISOString(),
                time: new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', second: '2-digit' }),
                date: new Date().toLocaleDateString('zh-CN'),
                status: data.status || 'normal',
                score: data.score,
                isQualified: data.is_qualified || false,
                issues: data.issues || [],
                suggestion: data.suggestion || ''
            };

            historyLogs.unshift(record);
            
            // 限制最多保存100条
            if (historyLogs.length > 100) {
                historyLogs = historyLogs.slice(0, 100);
            }

            // 保存到 localStorage
            try {
                localStorage.setItem('postureHistory', JSON.stringify(historyLogs));
            } catch (e) {
                console.warn('保存历史记录失败:', e);
            }

            updateHistoryBadge();
        }

        function loadHistory() {
            // 从 localStorage 加载
            try {
                const saved = localStorage.getItem('postureHistory');
                if (saved) {
                    historyLogs = JSON.parse(saved);
                }
            } catch (e) {
                console.warn('加载历史记录失败:', e);
            }

            renderHistoryList();
        }

        function renderHistoryList() {
            if (historyLogs.length === 0) {
                historyList.innerHTML = `
                    <div class="history-empty">
                        <span class="material-icons-round">inbox</span>
                        <span>暂无检测记录</span>
                    </div>
                `;
                return;
            }

            historyList.innerHTML = historyLogs.map((record, index) => {
                const score = record.score !== undefined && record.score !== null ? record.score : '--';
                let scoreClass = 'neutral';
                let icon = 'help_outline';
                let title = '未知状态';

                if (record.status === 'no_person') {
                    title = '未检测到人物';
                    icon = 'person_off';
                } else if (record.status === 'not_writing') {
                    title = '不在写字状态';
                    icon = 'edit_off';
                } else if (typeof score === 'number') {
                    if (score >= 80) {
                        scoreClass = 'good';
                        icon = 'check_circle';
                        title = '姿势正确';
                    } else if (score >= 60) {
                        scoreClass = 'bad';
                        icon = 'info';
                        title = '需要改进';
                    } else {
                        scoreClass = 'bad';
                        icon = 'warning';
                        title = '姿势不佳';
                    }
                }

                const issuesHtml = record.issues && record.issues.length > 0 
                    ? `<div class="history-item-issues">${record.issues.map(i => `<span>${i}</span>`).join('')}</div>`
                    : '';

                const suggestionHtml = record.suggestion 
                    ? `<div class="history-item-suggestion">💡 ${record.suggestion}</div>`
                    : '';

                return `
                    <div class="history-item" style="animation-delay: ${index * 0.05}s">
                        <div class="history-item-score ${scoreClass}">${score}</div>
                        <div class="history-item-content">
                            <div class="history-item-header">
                                <span class="history-item-title">
                                    <span class="material-icons-round">${icon}</span>
                                    ${title}
                                </span>
                                <span class="history-item-time">${record.time}</span>
                            </div>
                            ${issuesHtml}
                            ${suggestionHtml}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function clearHistory() {
            if (confirm('确定要清空所有检测记录吗？')) {
                historyLogs = [];
                try {
                    localStorage.removeItem('postureHistory');
                } catch (e) {}
                renderHistoryList();
                updateHistoryBadge();
                showToast('记录已清空', 'delete');
            }
        }

        function updateHistoryBadge() {
            const count = historyLogs.length;
            if (count > 0) {
                historyBadge.textContent = count > 99 ? '99+' : count;
                historyBadge.style.display = 'flex';
            } else {
                historyBadge.style.display = 'none';
            }
        }

        // ============ 初始化 ============
        document.addEventListener('DOMContentLoaded', async () => {
            await startCamera();
            if (zoomSlider) {
                zoomSlider.addEventListener('input', (e) => setZoom(e.target.value));
            }
            // 加载历史记录
            loadHistory();
            updateHistoryBadge();
        });

        window.addEventListener('beforeunload', stopCamera);

        // ESC 关闭面板
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && historyPanel.classList.contains('show')) {
                closeHistoryPanel();
            }
        });
    </script>
</body>
</html>

